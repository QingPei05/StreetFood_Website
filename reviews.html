<!doctype html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reviews ‚Äî Explore Street Food</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css">
</head>

<body class="reviews-page">
  <!-- Shared Auth Gate -->
  <script src="scripts/auth-gate.js"></script>

  <!-- Navbar -->
  <div data-include="partials/navbar.html"></div>

  <main class="container py-5">
    <div class="page-header">
      <h1 class="page-title">Leave a Review</h1>
      <p class="page-subtitle">Share your street food experience with others</p>
    </div>

    <div class="review-form-container">
      <form id="form" class="review-form needs-validation" novalidate>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Food</label>
            <input required class="form-control" id="food" placeholder="e.g., Satay" />
            <div class="invalid-feedback">Please enter a food name.</div>
          </div>
          <div class="form-group">
            <label class="form-label">Your Name</label>
            <input required class="form-control" id="name" placeholder="e.g., Ali" />
            <div class="invalid-feedback">Please enter your name.</div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Comment</label>
          <textarea required class="form-control" id="comment" rows="4" placeholder="What did you like about this food? Share your experience..."></textarea>
          <div class="invalid-feedback">Please add a comment.</div>
        </div>
        
        <div class="rating-group">
          <label class="form-label">Rating</label>
          <div class="rating-input-container">
            <input type="number" id="rating" class="form-control" min="1" max="5" value="5" required />
            <span class="rating-text">out of 5 stars</span>
          </div>
          <div class="invalid-feedback">Rating must be 1‚Äì5.</div>
        </div>
        
        <div class="form-actions">
          <button class="btn btn-primary btn-submit" type="submit">
            <span class="btn-icon">üìù</span>
            Submit Review
          </button>
          <button class="btn btn-outline-secondary btn-clear" type="button" id="clear">
            <span class="btn-icon">üóëÔ∏è</span>
            Clear All
          </button>
        </div>
      </form>
    </div>

    <div class="reviews-section">
      <div class="section-header">
        <h2 class="section-title">Recent Reviews</h2>
        <div class="section-divider"></div>
      </div>
      <div id="list" class="reviews-list"></div>
    </div>
  </main>

  <div data-include="partials/footer.html"></div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="partials/loader.js"></script>
  <script src="main.js"></script>
  <script>
    const form = document.getElementById('form');
    const foodInput = document.getElementById('food');
    const nameInput = document.getElementById('name');
    const commentInput = document.getElementById('comment');
    const ratingInput = document.getElementById('rating');
    const list = document.getElementById('list');
    
    form.addEventListener('submit', e => {
      form.classList.add('was-validated');
      if (!form.checkValidity()) { 
        e.preventDefault(); 
        e.stopPropagation(); 
        return; 
      }
      
      e.preventDefault();
      const entry = { 
        food: foodInput.value.trim(), 
        name: nameInput.value.trim(), 
        comment: commentInput.value.trim(), 
        rating: +ratingInput.value, 
        ts: Date.now() 
      };
      
      const arr = JSON.parse(localStorage.getItem('reviews') || '[]'); 
      arr.unshift(entry);
      localStorage.setItem('reviews', JSON.stringify(arr));
      
      form.reset(); 
      form.classList.remove('was-validated'); 
      
      // Add the new review to the display immediately
      addReviewToDisplay(entry);
      
      // Show success feedback
      showSuccessMessage();
    });
    
    document.getElementById('clear').onclick = () => { 
      if (confirm('Are you sure you want to clear all reviews?')) {
        localStorage.removeItem('reviews'); 
        render(); 
      }
    }
    
    function addReviewToDisplay(review) {
      const d = new Date(review.ts).toLocaleString();
      const reviewHTML = `
        <div class="review-card">
          <div class="review-header">
            <div class="review-food-name">${review.food}</div>
            <div class="review-rating">
              <span class="stars-filled">${'‚òÖ'.repeat(review.rating)}</span><span class="stars-empty">${'‚òÜ'.repeat(5 - review.rating)}</span>
            </div>
          </div>
          <div class="review-meta">
            <div class="user-profile">
              <div class="user-avatar">
                <img src="assets/images/profile-user-svgrepo-com.svg" alt="User Profile" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                <div class="user-avatar-fallback" style="display: none;">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" fill="#f8f9fa"/>
                    <circle cx="12" cy="9" r="3" fill="#6c757d"/>
                    <path d="M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662" stroke="#6c757d" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </div>
              </div>
              <div class="user-info">
                <div class="reviewer-name">${review.name}</div>
                <div class="review-date">${d}</div>
              </div>
            </div>
          </div>
          <div class="review-comment">${review.comment}</div>
        </div>`;
      
      // If the "no reviews" message is showing, replace it
      if (list.innerHTML.includes('no-reviews')) {
        list.innerHTML = reviewHTML;
      } else {
        // Otherwise insert at the top with animation
        list.insertAdjacentHTML('afterbegin', reviewHTML);
        list.firstElementChild.classList.add('review-card-new');
      }
    }
    
    function render() {
      list.innerHTML = '';
      const arr = JSON.parse(localStorage.getItem('reviews') || '[]');
      
      if (arr.length === 0) { 
        list.innerHTML = `
          <div class="no-reviews">
            <div class="no-reviews-icon">üçΩÔ∏è</div>
            <div class="no-reviews-text">No reviews yet.</div>
            <div class="no-reviews-subtext">Be the first to share your street food experience!</div>
          </div>`; 
        return; 
      }
      
      arr.forEach(review => {
        addReviewToDisplay(review);
      });
    }
    
    function showSuccessMessage() {
      const successMsg = document.createElement('div');
      successMsg.className = 'success-message';
      successMsg.innerHTML = `
        <div class="success-content">
          <span class="success-icon">‚úÖ</span>
          <span class="success-text">Review submitted successfully!</span>
        </div>
      `;
      
      document.body.appendChild(successMsg);
      
      setTimeout(() => {
        successMsg.classList.add('success-show');
      }, 100);
      
      setTimeout(() => {
        successMsg.classList.remove('success-show');
        setTimeout(() => {
          document.body.removeChild(successMsg);
        }, 300);
      }, 2000);
    }
    
    render();
  </script>
</body>

</html>
