<!doctype html>
<html lang="en" data-bs-theme="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explore Street Food â€” Account Settings</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
  <script>
    (function () { const k = 'session_user_v1'; if (!sessionStorage.getItem(k)) sessionStorage.setItem(k, 'Guest'); })();
  </script>

  <!-- Navbar (same markup youâ€™ll copy to other pages; dropdown menu is filled by main.js) -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Explore Street Food</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain"
        aria-controls="navMain" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">

          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="malaysia.html">Malaysia</a></li>
          <li class="nav-item"><a class="nav-link" href="global.html">Global</a></li>
          <li class="nav-item"><a class="nav-link" href="favourites.html">Favourites</a></li>
          <li class="nav-item"><a class="nav-link" href="search.html">Search</a></li>
          <li class="nav-item"><a class="nav-link" href="reviews.html">Reviews</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
          <li class="nav-item"><a class="nav-link" href="quiz.html">Quiz</a></li>
          <li class="nav-item"><a class="nav-link" href="map.html">Map</a></li>

          <!-- Avatar dropdown -->
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle p-0" href="#" data-bs-toggle="dropdown" aria-expanded="false"
              id="navUser" title="Hi, Guest" aria-label="Hi, Guest">
              <img src="profile-user-svgrepo-com.svg" alt="User Avatar" class="rounded-circle"
                style="width:32px;height:32px;object-fit:cover;">
            </a>

            <ul class="dropdown-menu dropdown-menu-end">

              <!-- Centered user header (auto-hidden for Guest by main.js) -->
              <li class="dropdown-userinfo text-center py-2">
                <div id="ddFullName" class="fw-bold">Guest</div>
                <div id="ddUsername" class="text-muted">@guest</div>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>

              <!-- Theme toggle -->
              <li>
                <button class="dropdown-item d-flex align-items-center gap-2" id="themeToggleItem" type="button">
                  <span id="themeToggleIcon" aria-hidden="true">ðŸŒ™</span>
                  <span id="themeToggleText">Dark mode</span>
                </button>
              </li>

              <!-- Account settings (hidden for Guest by main.js) -->
              <li><a class="dropdown-item" id="navAccountSettings" href="account.html">Account settings</a></li>

              <li>
                <hr class="dropdown-divider">
              </li>

              <!-- Same slot for Sign in (Guest) / Sign out (Signed-in). Text is set by main.js -->
              <li><button class="dropdown-item text-danger" id="navSignout" type="button">Sign out</button></li>
            </ul>
          </li>

        </ul>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="py-3 bg-body-tertiary border-bottom">
    <div class="container">
      <h1 class="mb-1">Account</h1>
      <p class="text-muted small mb-2">Sign in to your account or create a new one</p>
    </div>
  </header>

  <!-- Main -->
  <main class="container my-3 d-flex justify-content-center align-items-center" style="min-height:55vh;">
    <div class="w-100" style="max-width: 420px;">

      <!-- Guest notice -->
      <div id="guestNotice" class="alert alert-info mb-4 text-center">
        You are currently signed in as <strong id="guestName">Guest</strong>.
      </div>

      <!-- Sign In (PLAIN card) -->
      <div id="signinCard" class="card card-plain">
        <div class="card-body p-4">
          <h2 class="h5 mb-3 text-center">Sign In</h2>
          <form id="signinForm" novalidate>
            <div class="mb-3">
              <label for="si_name" class="form-label">Username</label>
              <input type="text" class="form-control" id="si_name" required>
              <div class="invalid-feedback">Please enter your username.</div>
            </div>
            <div class="mb-3">
              <label for="si_pass" class="form-label">Password</label>
              <div class="input-group">
                <input type="password" class="form-control" id="si_pass" required>
                <button class="btn btn-outline-secondary" type="button" id="si_toggle" aria-label="Show password">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="invalid-feedback">Please enter your password.</div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Sign In</button>
            <div id="si_msg" class="mt-3 small text-danger"></div>
          </form>
          <div class="mt-3 text-center">
            <a href="#" id="showSignup">Create new account</a>
          </div>
        </div>
      </div>

      <!-- Sign Up (PLAIN card) -->
      <div id="signupCard" class="card card-plain d-none">
        <div class="card-body p-4">
          <h2 class="h5 mb-3 text-center">Sign Up</h2>
          <form id="signupForm" novalidate>
            <div class="mb-3">
              <label for="su_fullname" class="form-label">name</label>
              <input type="text" class="form-control" id="su_fullname" required>
              <div class="invalid-feedback">Please enter your full name.</div>
            </div>
            <div class="mb-3">
              <label for="su_name" class="form-label">Username</label>
              <input type="text" class="form-control" id="su_name" required>
              <div class="invalid-feedback">Please choose a username.</div>
            </div>
            <div class="mb-3">
              <label for="su_pass" class="form-label">Password</label>
              <div class="input-group">
                <input type="password" class="form-control" id="su_pass" required>
                <button class="btn btn-outline-secondary" type="button" id="su_toggle" aria-label="Show password">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="invalid-feedback">Please enter a password.</div>
            </div>
            <button type="submit" class="btn btn-success w-100">Sign Up</button>
            <div id="su_msg" class="mt-3 small text-danger"></div>
          </form>
          <div class="mt-3 text-center">
            <a href="#" id="backToSignin">Back to Sign In</a>
          </div>
        </div>
      </div>

      <!-- Signed In (PLAIN card) -->
      <div id="sectionSigned" class="card card-plain d-none mt-4">
        <div class="card-body p-4 text-center">
          <h2 class="h5 mb-3">Welcome, <span id="signedName"></span></h2>
          <p class="text-secondary">You are signed in.</p>

          <div class="d-flex flex-wrap justify-content-center gap-2">
            <a href="change-password.html" class="btn btn-outline-primary">Change Password</a>
            <button id="btnChangeName" class="btn btn-outline-primary">Change Full Name</button>
            <button id="btnChangeUsername" class="btn btn-outline-primary">Change Username</button>
            <button id="btnDeleteAccount" class="btn btn-outline-danger">Delete Account</button>
            <button id="btnSwitchAccount" class="btn btn-outline-secondary">Sign in as different user</button>
            <button id="btnSignout" class="btn btn-danger">Sign Out</button>
          </div>
        </div>
      </div>

    </div>
  </main>

  <footer class="py-4 bg-body-tertiary border-top mt-auto">
    <div class="container text-center small text-secondary">
      Â© 2025 Explore Street Food
      &nbsp;|&nbsp;
      <a href="about.html" class="text-decoration-none">Group 61</a>
    </div>
  </footer>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="main.js"></script>

  <script>
    // === Account-page-only behaviors (kept minimal; everything global is in main.js) ===
    document.addEventListener('DOMContentLoaded', () => {
      const SESSION_KEY = 'session_user_v1';
      const ACC_KEY = 'accounts_v1';
      const LAST_USER_KEY = 'last_user_v1';

      const signinCard = document.getElementById('signinCard');
      const signupCard = document.getElementById('signupCard');
      const guestNotice = document.getElementById('guestNotice');
      const guestName = document.getElementById('guestName');
      const sectionSigned = document.getElementById('sectionSigned');
      const signedName = document.getElementById('signedName');

      const showSignup = document.getElementById('showSignup');
      const backToSignin = document.getElementById('backToSignin');

      function showSignUp() { signinCard.classList.add('d-none'); signupCard.classList.remove('d-none'); }
      function showSignIn() { signupCard.classList.add('d-none'); signinCard.classList.remove('d-none'); }

      showSignup?.addEventListener('click', e => { e.preventDefault(); showSignUp(); });
      backToSignin?.addEventListener('click', e => { e.preventDefault(); showSignIn(); });

      function eye(btnId, inputId) {
        const btn = document.getElementById(btnId), input = document.getElementById(inputId);
        btn?.addEventListener('click', () => {
          const show = input.type === 'password';
          input.type = show ? 'text' : 'password';
          const i = btn.querySelector('i'); if (i) { i.classList.toggle('bi-eye', !show); i.classList.toggle('bi-eye-slash', show); }
        });
      }
      eye('si_toggle', 'si_pass'); eye('su_toggle', 'su_pass');

      function loadAccounts() { try { return JSON.parse(localStorage.getItem(ACC_KEY) || '{}'); } catch { return {}; } }
      function saveAccounts(o) { localStorage.setItem(ACC_KEY, JSON.stringify(o || {})); }

      function refreshUI() {
        const u = sessionStorage.getItem(SESSION_KEY) || 'Guest';
        const acc = loadAccounts();
        const isGuest = (u === 'Guest' || !acc[u]);

        guestName.textContent = u;
        signedName.textContent = u;
        const accMap = loadAccounts();
        signedName.textContent = (accMap[u]?.fullName || u);

        guestNotice.classList.toggle('d-none', !isGuest);
        signinCard.classList.toggle('d-none', !isGuest);
        signupCard.classList.add('d-none'); // default
        sectionSigned.classList.toggle('d-none', isGuest);
      }

      // Sign Up
      const signupForm = document.getElementById('signupForm');
      signupForm?.addEventListener('submit', e => {
        e.preventDefault();
        signupForm.classList.add('was-validated');
        if (!signupForm.checkValidity()) return;

        const full = document.getElementById('su_fullname').value.trim();
        const user = document.getElementById('su_name').value.trim();
        const pass = document.getElementById('su_pass').value;
        const msg = document.getElementById('su_msg');

        const acc = loadAccounts();
        if (acc[user]) {
          msg.textContent = 'Username already exists.';
          // clear for convenience
          document.getElementById('su_name').value = '';
          document.getElementById('su_pass').value = '';
          return;
        }

        acc[user] = { pass, fullName: full };
        saveAccounts(acc);

        sessionStorage.setItem(SESSION_KEY, user);
        localStorage.setItem(LAST_USER_KEY, user);
        refreshUI();
        if (window.renderAuthDropdown) window.renderAuthDropdown();

      });

      // Sign In
      const signinForm = document.getElementById('signinForm');
      signinForm?.addEventListener('submit', e => {
        e.preventDefault();
        signinForm.classList.add('was-validated');
        if (!signinForm.checkValidity()) return;

        const user = document.getElementById('si_name').value.trim();
        const pass = document.getElementById('si_pass').value;
        const msg = document.getElementById('si_msg');

        const acc = loadAccounts();
        if (!acc[user] || acc[user].pass !== pass) {
          msg.textContent = 'Invalid username or password.';
          // clear inputs for easier retry
          document.getElementById('si_name').value = '';
          document.getElementById('si_pass').value = '';
          return;
        }

        sessionStorage.setItem(SESSION_KEY, user);
        localStorage.setItem(LAST_USER_KEY, user);
        refreshUI();
        if (window.renderAuthDropdown) window.renderAuthDropdown();
        location.href = 'index.html';
      });

      // Signed-in actions
      document.getElementById('btnSignout')?.addEventListener('click', () => {
        sessionStorage.setItem(SESSION_KEY, 'Guest');
        localStorage.removeItem(LAST_USER_KEY);
        refreshUI();
        if (window.renderAuthDropdown) window.renderAuthDropdown();
        location.href = 'account.html';
      });

      document.getElementById('btnSwitchAccount')?.addEventListener('click', () => {
        sessionStorage.setItem(SESSION_KEY, 'Guest');
        localStorage.removeItem(LAST_USER_KEY);
        refreshUI();
        if (window.renderAuthDropdown) window.renderAuthDropdown();
        document.getElementById('signinCard').scrollIntoView({ behavior: 'smooth' });
      });

      // Change Full Name (prompt)
      document.getElementById('btnChangeName')?.addEventListener('click', () => {
        const u = sessionStorage.getItem(SESSION_KEY) || 'Guest';
        const acc = loadAccounts();
        if (u === 'Guest' || !acc[u]) return;
        const now = acc[u].fullName || u;
        const val = prompt('Enter your full name:', now);
        if (val === null) return; // cancel
        const name = val.trim();
        if (!name) return alert('Full name cannot be empty.');
        acc[u].fullName = name;
        saveAccounts(acc);
        if (window.renderAuthDropdown) window.renderAuthDropdown();
        alert('Full name updated.');
      });

      // Change Username (prompt + rename key)  
      document.getElementById('btnChangeUsername')?.addEventListener('click', () => {
        const u = sessionStorage.getItem(SESSION_KEY) || 'Guest';
        const acc = loadAccounts();
        if (u === 'Guest' || !acc[u]) return;
        const val = prompt('Enter a new username:', u);
        if (val === null) return; // cancel
        const nu = val.trim();
        if (!nu) return alert('Username cannot be empty.');
        if (acc[nu] && nu !== u) return alert('This username is already taken.');

        if (nu !== u) {
          acc[nu] = { ...acc[u] };
          delete acc[u];
          saveAccounts(acc);

          // --- migrate favourites data to new username ---
          const oldListKey = `favourites_${u}`;
          const oldMetaKey = `favourites_meta_${u}`;
          const newListKey = `favourites_${nu}`;
          const newMetaKey = `favourites_meta_${nu}`;

          const list = localStorage.getItem(oldListKey);
          const meta = localStorage.getItem(oldMetaKey);

          if (list && !localStorage.getItem(newListKey)) localStorage.setItem(newListKey, list);
          if (meta && !localStorage.getItem(newMetaKey)) localStorage.setItem(newMetaKey, meta);

          localStorage.removeItem(oldListKey);
          localStorage.removeItem(oldMetaKey);
          // --- end migration ---

          sessionStorage.setItem(SESSION_KEY, nu);
          localStorage.setItem(LAST_USER_KEY, nu);
          signedName.textContent = nu;
          if (window.renderAuthDropdown) window.renderAuthDropdown();
        }
        alert('Username updated.');
        refreshUI();
      });

      // Delete Account  
      document.getElementById('btnDeleteAccount')?.addEventListener('click', () => {
        const u = sessionStorage.getItem(SESSION_KEY) || 'Guest';
        const acc = loadAccounts();
        if (u === 'Guest' || !acc[u]) return;
        if (!confirm('Delete your account? This cannot be undone.')) return;

        delete acc[u];
        saveAccounts(acc);

        // --- cleanup favourites when account is deleted ---
        localStorage.removeItem(`favourites_${u}`);
        localStorage.removeItem(`favourites_meta_${u}`);
        // --- end cleanup ---

        sessionStorage.setItem(SESSION_KEY, 'Guest');
        localStorage.removeItem(LAST_USER_KEY);
        refreshUI();
        if (window.renderAuthDropdown) window.renderAuthDropdown();
        alert('Account deleted.');
        location.href = 'account.html';
      });

      refreshUI();
      if (window.renderAuthDropdown) window.renderAuthDropdown();

      try {
        const p = new URL(location.href).searchParams.get('msg');
        if (p === 'password_changed') {
          alert('Password updated successfully.');
          history.replaceState({}, '', 'account.html');
        } else if (p === 'signin_required') {
          alert('Please sign in to continue.');
          history.replaceState({}, '', 'account.html');
        }
      } catch (_) { }

    });
  </script>
</body>

</html>
